name: Benchmark

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: write
  pull-requests: write

env:
  CARGO_TERM_COLOR: always

jobs:
  benchmark:
    name: Performance Regression Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Run benchmarks
        run: cargo bench --workspace --exclude mithril-python -- --noplot --save-baseline current

      - name: Download previous benchmark results
        uses: actions/cache@v4
        with:
          path: target/criterion
          key: benchmark-${{ runner.os }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            benchmark-${{ runner.os }}-

      - name: Compare benchmarks
        id: bench-compare
        run: |
          # Run comparison if baseline exists
          if [ -d "target/criterion" ]; then
            echo "Comparing against baseline..."
            cargo bench --workspace --exclude mithril-python -- --noplot --baseline baseline 2>&1 | tee bench-results.txt || true

            # Check for significant regressions (>15%)
            if grep -q "Performance has regressed" bench-results.txt; then
              echo "regression=true" >> $GITHUB_OUTPUT
              echo "::warning::Performance regression detected!"
            else
              echo "regression=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "No baseline found, creating initial baseline..."
            echo "regression=false" >> $GITHUB_OUTPUT
          fi

      - name: Save benchmark baseline
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          # Save current results as baseline for future comparisons
          cp -r target/criterion target/criterion-baseline 2>/dev/null || true

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: |
            target/criterion
            bench-results.txt
          if-no-files-found: ignore

      - name: Comment on PR with benchmark results
        if: github.event_name == 'pull_request' && steps.bench-compare.outputs.regression == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let body = '## Benchmark Results\n\n';
            body += ':warning: **Performance regression detected!**\n\n';

            try {
              const results = fs.readFileSync('bench-results.txt', 'utf8');
              body += '```\n' + results.substring(0, 5000) + '\n```';
            } catch (e) {
              body += 'See workflow artifacts for details.';
            }

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

  # Store historical benchmark data
  store-results:
    name: Store Benchmark History
    runs-on: ubuntu-latest
    needs: benchmark
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      - name: Download benchmark results
        uses: actions/download-artifact@v4
        with:
          name: benchmark-results
          path: benchmark-results

      - name: Store benchmark data
        uses: benchmark-action/github-action-benchmark@v1
        with:
          name: Mithril Benchmarks
          tool: 'cargo'
          output-file-path: benchmark-results/criterion/report/index.html
          github-token: ${{ secrets.GITHUB_TOKEN }}
          auto-push: true
          alert-threshold: '150%'
          comment-on-alert: true
          fail-on-alert: false
        continue-on-error: true  # Don't fail if benchmark data format changes
